---
- name: Configure App Hosts with Dynatrace OneAgent
  hosts: app
  become: true

  vars_files:
    - vars/main.yml

  vars:
    oneagent_environment_url: "{{ vault_oneagent_environment_url }}"
    oneagent_paas_token: "{{ vault_oneagent_paas_token }}"
    oneagent_validate_certs: false
    oneagent_preserve_installer: true
    oneagent_install_args:
      - "--set-host-name={{ inventory_hostname }}"
      - --set-app-log-content-access=true 
  tasks:
    - name: Import Dynatrace Role
      ansible.builtin.import_role:
        name: dynatrace.oneagent.oneagent

    - name: Ensure Dynatrace OneAgent is running
      ansible.builtin.systemd:
        name: oneagent.service
        state: started
        enabled: true
      when: dynatrace_agent.changed

